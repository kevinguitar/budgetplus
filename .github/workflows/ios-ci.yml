name: iOS CI

on:
  pull_request:

# Cancel any current or previous job from the same PR
concurrency:
  group: ios-ci-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}
          gradle-home-cache-strict-match: true
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}

      - name: Setup Secrets
        env:
          REVENUECAT_API_KEY: ${{ secrets.REVENUECAT_API_KEY }}
          GOOGLE_SERVICES_PLIST: ${{ secrets.IOS_GOOGLE_SERVICES_PLIST }}
        run: |
          echo REVENUECAT_API_KEY=$REVENUECAT_API_KEY > ./local.properties
          echo $GOOGLE_SERVICES_PLIST | base64 -d > ./iosApp/iosApp/GoogleService-Info.plist

      - name: Set JAVA_HOME for Xcode build phase
        run: echo "export JAVA_HOME=$JAVA_HOME" > ./iosApp/.xcode.env

      - name: Cache SPM packages
        uses: actions/cache@v4
        with:
          path: |
            build/SourcePackages
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Build iOS App (simulator)
        run: |
          xcodebuild build \
            -project iosApp/iosApp.xcodeproj \
            -scheme iosApp \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination 'generic/platform=iOS Simulator' \
            -derivedDataPath ./build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            ARCHS=arm64 \
            ONLY_ACTIVE_ARCH=YES \
            -skipPackagePluginValidation \
            -quiet


